<div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black flex items-center justify-center p-4 sm:p-6 lg:p-8">

  <!-- Custom Message Box -->
  @if (message()) {
    <div class="fixed top-4 right-4 p-4 rounded-lg shadow-lg flex items-center justify-between z-50
                {{ message()!.isError ? 'bg-red-600 text-white' : 'bg-green-600 text-white' }}">
      <span>{{ message()!.text }}</span>
      <button (click)="clearMessage()" class="ml-4 font-bold text-lg hover:opacity-75 transition-opacity">&times;</button>
    </div>
  }

  @if(!isJoined()) {
    <div class="w-full max-w-md bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl text-center border border-gray-700">
      <h1 class="text-3xl sm:text-4xl font-bold text-white mb-6">ğŸµ Music Guesser</h1>
      <div class="mb-4 text-left">
        <label for="roomName" class="block text-gray-300 text-sm font-semibold mb-2">Room:</label>
        <input id="roomName" [(ngModel)]="room" placeholder="Enter room name" maxlength="20"
               class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
      </div>
      <div class="mb-6 text-left">
        <label for="nickname" class="block text-gray-300 text-sm font-semibold mb-2">Nickname:</label>
        <input id="nickname" [(ngModel)]="nickname" placeholder="Enter your nickname" maxlength="20"
               class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
      </div>
      <button (click)="joinRoom()"
              class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl">
        Join Room
      </button>
    </div>
  }

  @if(isJoined() && !gameStarted() && !gameEnded()) {
    <div class="w-full max-w-lg bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl text-center border border-gray-700">
      <h2 class="text-2xl sm:text-3xl font-bold text-white mb-4">ğŸ  Room: {{room()}}</h2>

      <h3 class="text-xl sm:text-2xl font-semibold text-gray-300 mb-4">ğŸ‘¥ Players:</h3>
      <ul class="player-list space-y-2 mb-6">
        @for(player of players(); track player.nickname) {
          <li class="flex flex-col sm:flex-row items-center justify-between p-3 bg-gray-700 rounded-lg shadow-sm border border-gray-600">
            <span class="font-medium text-white">{{player.nickname}}</span>
            <span class="text-gray-300 text-sm">Song: {{player.hasUploaded ? 'âœ…' : 'âŒ'}}</span>
            <span class="text-gray-300 text-sm">Score: {{player.score}}</span>
          </li>
        }
      </ul>

      <!-- Submitted Songs Section -->
      @if (players().length > 0) {
        <div class="bg-gray-700 p-4 rounded-lg mb-6 border border-gray-600">
          <h4 class="text-lg font-semibold text-yellow-400 mb-3">ğŸµ Submitted Songs:</h4>
          <div class="space-y-2">
            @for (player of players(); track player.nickname) {
              <div class="flex items-center justify-between p-3 bg-gray-600 rounded border border-gray-500">
                <div class="flex items-center gap-3">
                  <span class="font-medium text-white">{{player.nickname}}</span>
                  @if (player.hasUploaded) {
                    <span class="text-green-400 text-sm">âœ… Submitted</span>
                  } @else {
                    <span class="text-red-400 text-sm">âŒ Not submitted</span>
                  }
                </div>
                @if (player.hasUploaded && player.spotifyTrack) {
                  <div class="flex items-center gap-2 text-sm text-gray-300">
                    <span>{{player.spotifyTrack.name}}</span>
                    <span class="text-gray-400">by</span>
                    <span>{{getArtistsNames(player.spotifyTrack.artists)}}</span>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }

      <!-- Spotify Authentication Section -->
      <div class="bg-gradient-to-r from-green-600 to-green-700 rounded-lg shadow-lg p-6 mb-6 border border-green-500">
        <h3 class="text-xl font-bold text-white mb-4">ğŸµ Spotify Authentication:</h3>
        @if (spotifyAuth.isAuthenticated()) {
          <div class="flex items-center justify-between">
            <div class="text-white">
              <p class="font-semibold">âœ… Connected to Spotify</p>
              <p class="text-sm opacity-90">Welcome, {{spotifyAuth.currentSession()?.userName}}!</p>
            </div>
            <button (click)="spotifyAuth.logout()" 
                    class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">
              Logout
            </button>
          </div>
        } @else {
          <div class="flex items-center justify-between">
            <div class="text-white">
              <p class="font-semibold">ğŸ”’ Not connected to Spotify</p>
              <p class="text-sm opacity-90">Login required to search songs and play previews</p>
            </div>
            <button (click)="spotifyAuth.login()" 
                    class="bg-white hover:bg-gray-100 text-green-600 font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">
              Login with Spotify
            </button>
          </div>
        }
        @if (spotifyAuth.isLoading()) {
          <div class="mt-4 text-center">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
            <p class="text-white text-sm mt-2">Authenticating...</p>
          </div>
        }
      </div>

      @if(isHost()) {
        <div class="host-controls bg-gray-700 p-6 rounded-lg shadow-lg mb-6 border border-gray-600">
          <h4 class="text-lg sm:text-xl font-semibold text-blue-400 mb-4">ğŸ® Game Setup:</h4>
          
          <div class="mb-4 text-left">
            <label for="turnDuration" class="block text-gray-300 text-sm font-semibold mb-2">Turn Duration (seconds):</label>
            <input id="turnDuration" type="number" [(ngModel)]="turnDuration" min="10" max="120"
                   class="w-full px-4 py-3 bg-gray-600 border border-gray-500 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
          </div>
          
          <!-- Song Selection Section -->
          <div class="mb-6">
            <h5 class="text-lg font-semibold text-gray-300 mb-3">ğŸµ Select Your Song:</h5>
            <div class="mb-4">
              <input 
                [(ngModel)]="spotifySearchQuery"
                (input)="searchSpotifySongs()"
                placeholder="Search for songs on Spotify..."
                class="w-full px-4 py-3 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
              />
            </div>
            
            <!-- Search Results Dropdown -->
            @if (spotifySearchResults().length > 0) {
              <div class="search-results bg-gray-600 border border-gray-500 rounded-lg max-h-60 overflow-y-auto mb-2">
                @for (track of spotifySearchResults(); track track.id) {
                  <div 
                    (click)="selectSpotifyTrack(track)"
                    class="p-3 hover:bg-gray-500 cursor-pointer border-b border-gray-500 last:border-b-0"
                  >
                    <div class="flex items-center gap-3">
                      @if (track.album.images[0]) {
                        <img [src]="track.album.images[0].url" [alt]="track.album.name" 
                             class="w-12 h-12 rounded object-cover"/>
                      }
                      <div class="flex-1">
                        <p class="font-semibold text-white">{{track.name}}</p>
                        <p class="text-sm text-gray-300">{{getArtistsNames(track.artists)}}</p>
                        <p class="text-xs text-gray-400">{{track.album.name}}</p>
                        @if (track.preview_url) {
                          <p class="text-xs text-green-400">ğŸµ Preview Available</p>
                        } @else {
                          <p class="text-xs text-red-400">ğŸ”‡ No Preview</p>
                        }
                      </div>
                      <div class="text-xs text-gray-400">
                        {{formatDuration(track.duration_ms)}}
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
            
            <!-- Selected Song Display -->
            @if (selectedSpotifyTrack()) {
              <div class="selected-track bg-green-900 p-3 rounded-lg mb-2 border border-green-600">
                <h5 class="font-semibold text-green-300 mb-2">ğŸµ Your Selected Song:</h5>
                <div class="flex items-center gap-3">
                  @if (selectedSpotifyTrack()!.album.images[0]) {
                    <img [src]="selectedSpotifyTrack()!.album.images[0].url" 
                         class="w-12 h-12 rounded object-cover"/>
                  }
                  <div class="flex-1">
                    <p class="font-semibold text-sm text-white">{{selectedSpotifyTrack()!.name}}</p>
                    <p class="text-xs text-gray-300">{{getArtistsNames(selectedSpotifyTrack()!.artists)}}</p>
                    <p class="text-xs text-gray-400">{{selectedSpotifyTrack()!.album.name}}</p>
                    @if (selectedSpotifyTrack()!.preview_url) {
                      <p class="text-xs text-green-400">ğŸµ Preview Available</p>
                    } @else {
                      <p class="text-xs text-red-400">ğŸ”‡ No Preview</p>
                    }
                  </div>
                  <div class="text-xs text-gray-400">
                    {{formatDuration(selectedSpotifyTrack()!.duration_ms)}}
                  </div>
                </div>
              </div>
            }
            
            <!-- Submit Button -->
            @if (selectedSpotifyTrack()) {
              <button (click)="submitSpotifyTrack()" 
                      class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl">
                Submit Song
              </button>
            }
          </div>
          
          <!-- Start Game Button -->
          @if (allPlayersUploaded()) {
            <button (click)="startGame()" 
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl">
              Start Game
            </button>
          } @else {
            <button disabled 
                    class="w-full bg-gray-600 text-gray-400 font-bold py-3 px-4 rounded-lg cursor-not-allowed">
              Waiting for all players to submit songs...
            </button>
          }
        </div>
      }
    </div>
  }

  @if(isJoined() && gameStarted() && !gameEnded()) {
    <div class="w-full max-w-4xl bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-700">
      <h2 class="text-2xl sm:text-3xl font-bold text-white mb-6 text-center">ğŸµ Music Guesser Game</h2>

      <!-- Answer Display Overlay -->
      @if (showingAnswer() && answerData()) {
        <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
          <div class="bg-gray-800 rounded-lg p-8 max-w-md mx-4 text-center border border-gray-600">
            <h3 class="text-2xl font-bold text-white mb-4">ğŸµ The Answer Was:</h3>
            <div class="mb-4">
              <p class="text-xl font-semibold text-blue-400">{{answerData()!.songTitle}}</p>
              <p class="text-lg text-gray-300">by {{answerData()!.songArtist}}</p>
            </div>
            @if (answerData()!.spotifyTrack && answerData()!.spotifyTrack.album.images[0]) {
              <img [src]="answerData()!.spotifyTrack.album.images[0].url" 
                   [alt]="answerData()!.spotifyTrack.album.name"
                   class="w-32 h-32 mx-auto rounded-lg mb-4 object-cover"/>
            }
            <div class="text-sm text-gray-400">
              <p>Next turn starting in 5 seconds...</p>
            </div>
          </div>
        </div>
      }

      <!-- Game Controls -->
      <div class="game-controls flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
        @if (!audioEnabled) {
          <button (click)="enableAudio()" 
                  class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">
            ğŸ”Š Enable Music
          </button>
        }
        <div class="volume-control flex items-center gap-2 bg-gray-700 p-3 rounded-lg shadow-sm border border-gray-600">
          <label class="text-gray-300 font-medium">Volume: {{volumeControl()}}%</label>
          <input type="range" min="0" max="100" [ngModel]="volumeControl()" (ngModelChange)="volumeControl.set($event)"
                 class="w-full sm:w-32 accent-blue-500"/>
        </div>
      </div>

      <!-- Current Turn Info -->
      <div class="bg-gray-700 p-4 rounded-lg mb-6 border border-gray-600">
        <h3 class="text-xl font-bold text-white mb-2">ğŸ® Current Turn:</h3>
        <p class="text-gray-300">It's <span class="font-semibold text-blue-400">{{currentTurnNickname()}}</span>'s turn!</p>
        <p class="text-sm text-gray-400 mt-1">Time remaining: {{timeLeftDisplay}}s</p>
      </div>

      <!-- Players List -->
      <div class="bg-gray-700 p-4 rounded-lg mb-6 border border-gray-600">
        <h3 class="text-lg font-semibold text-white mb-3">ğŸ‘¥ Players:</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          @for(player of players(); track player.nickname) {
            <div class="flex items-center justify-between p-3 bg-gray-600 rounded border border-gray-500">
              <span class="font-medium text-white">{{player.nickname}}</span>
              <span class="text-gray-300 text-sm">Score: {{player.score}}</span>
            </div>
          }
        </div>
      </div>

      <!-- Chat Section -->
      <div class="bg-gray-700 p-4 rounded-lg mb-6 border border-gray-600">
        <h3 class="text-lg font-semibold text-white mb-3">ğŸ’¬ Game Chat:</h3>
        <div class="chat-messages bg-gray-600 h-40 overflow-y-auto p-3 rounded border border-gray-500 mb-3">
          @for(message of chatMessages(); track message.timestamp) {
            <div class="mb-2 text-sm">
              <span class="font-semibold text-blue-400">{{message.nickname}}:</span>
              <span class="text-gray-300 ml-2">{{message.message}}</span>
            </div>
          }
        </div>
        <div class="flex gap-2">
          <input 
            [(ngModel)]="chatInput" 
            (keydown.enter)="sendChatMessage()"
            placeholder="Type your guess or message..."
            class="flex-1 px-3 py-2 bg-gray-600 border border-gray-500 rounded text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <button (click)="sendChatMessage()" 
                  class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition duration-300">
            Send
          </button>
        </div>
      </div>

      <!-- Host Controls -->
      @if(isHost()) {
        <div class="bg-gray-700 p-4 rounded-lg border border-gray-600">
          <h3 class="text-lg font-semibold text-white mb-3">ğŸ® Host Controls:</h3>
          <div class="flex gap-3">
            <button (click)="skipTurn()" 
                    class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded transition duration-300">
              Skip Turn
            </button>
            <button (click)="resetGame()" 
                    class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded transition duration-300">
              Reset Game
            </button>
          </div>
        </div>
      }
    </div>
  }

  @if(isJoined() && gameEnded()) {
    <div class="w-full max-w-lg bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl text-center border border-gray-700">
      <h2 class="text-2xl sm:text-3xl font-bold text-white mb-6">ğŸ‰ Game Over!</h2>
      
      <h3 class="text-xl font-semibold text-yellow-400 mb-4">ğŸ† Final Scores:</h3>
      <ul class="space-y-2 mb-6">
        @for(score of scores(); track score.nickname) {
          <li class="flex justify-between items-center p-3 bg-gray-700 rounded-lg border border-gray-600">
            <span class="font-medium text-white">{{score.nickname}}</span>
            <span class="text-gray-300">{{score.score}} points</span>
          </li>
        }
      </ul>
      
      @if(isHost()) {
        <button (click)="resetGame()" 
                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl">
          Play Again
        </button>
      } @else {
        <p class="text-gray-400">Waiting for host to start a new game...</p>
      }
    </div>
  }

</div>