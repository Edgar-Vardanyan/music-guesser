<div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black flex items-center justify-center p-4 sm:p-6 lg:p-8">

  <!-- Custom Message Box -->
  @if (message()) {
    <div class="fixed top-4 right-4 p-4 rounded-lg shadow-lg flex items-center justify-between z-50
                {{ message()!.isError ? 'bg-red-600 text-white' : 'bg-green-600 text-white' }}">
      <span>{{ message()!.text }}</span>
      <button (click)="clearMessage()" class="ml-4 font-bold text-lg hover:opacity-75 transition-opacity">&times;</button>
    </div>
  }

  @if(!isJoined()) {
    <!-- Spotify Login Required -->
    @if (!spotifyAuth.isAuthenticated()) {
      <div class="w-full max-w-md bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl text-center border border-gray-700">
        <h1 class="text-3xl sm:text-4xl font-bold text-white mb-4">üéµ Music Guesser</h1>
        
        <div class="mb-6">
          <div class="bg-green-600 rounded-full p-4 inline-block mb-4">
            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.84-.179-.84-.66 0-.362.24-.659.54-.779 4.56-1.341 8.521-.961 11.641 1.32.42.18.479.659.241 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-2.001-8.159-2.58-11.939-1.379-.48.141-1.02-.12-1.141-.66-.12-.48.12-1.02.6-1.14 4.2-1.26 9.6-.66 13.38 1.56.42.241.54.9.362 1.319zm.12-3.36C15.24 8.12 8.82 7.68 5.16 8.88c-.6.18-1.02-.179-1.14-.66-.12-.54.18-1.08.72-1.26 4.08-1.26 11.04-1.02 15.239 1.441.539.3.719 1.02.42 1.56-.3.421-1.02.599-1.559.3z"/>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-white mb-2">Login with Spotify</h2>
          <p class="text-gray-300 mb-6">You need to log in with Spotify to play Music Guesser</p>
          
          <button (click)="spotifyAuth.login()" 
                  class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-xl flex items-center justify-center gap-3">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.84-.179-.84-.66 0-.362.24-.659.54-.779 4.56-1.341 8.521-.961 11.641 1.32.42.18.479.659.241 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-2.001-8.159-2.58-11.939-1.379-.48.141-1.02-.12-1.141-.66-.12-.48.12-1.02.6-1.14 4.2-1.26 9.6-.66 13.38 1.56.42.241.54.9.362 1.319zm.12-3.36C15.24 8.12 8.82 7.68 5.16 8.88c-.6.18-1.02-.179-1.14-.66-.12-.54.18-1.08.72-1.26 4.08-1.26 11.04-1.02 15.239 1.441.539.3.719 1.02.42 1.56-.3.421-1.02.599-1.559.3z"/>
            </svg>
            Continue with Spotify
          </button>
          
          @if (spotifyAuth.isLoading()) {
            <div class="mt-4 text-center">
              <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
              <p class="text-gray-300 text-sm mt-2">Connecting to Spotify...</p>
            </div>
          }
        </div>
      </div>
    }
    
    <!-- Room Joining Form (After Spotify Login) -->
    @if (spotifyAuth.isAuthenticated()) {
      <div class="w-full max-w-md bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl text-center border border-gray-700">
        <div class="mb-4 pb-4 border-b border-gray-700">
          <div class="flex items-center justify-center gap-2 mb-2">
            <div class="bg-green-600 rounded-full p-2">
              <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.84-.179-.84-.66 0-.362.24-.659.54-.779 4.56-1.341 8.521-.961 11.641 1.32.42.18.479.659.241 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-2.001-8.159-2.58-11.939-1.379-.48.141-1.02-.12-1.141-.66-.12-.48.12-1.02.6-1.14 4.2-1.26 9.6-.66 13.38 1.56.42.241.54.9.362 1.319zm.12-3.36C15.24 8.12 8.82 7.68 5.16 8.88c-.6.18-1.02-.179-1.14-.66-.12-.54.18-1.08.72-1.26 4.08-1.26 11.04-1.02 15.239 1.441.539.3.719 1.02.42 1.56-.3.421-1.02.599-1.559.3z"/>
              </svg>
            </div>
            <h1 class="text-3xl sm:text-4xl font-bold text-white">üéµ Music Guesser</h1>
          </div>
          <p class="text-gray-400 text-sm">Logged in as {{spotifyAuth.currentSession()?.userName}}</p>
        </div>
        
        <div class="mb-4 text-left">
          <label for="roomName" class="block text-gray-300 text-sm font-semibold mb-2">Room:</label>
          <input id="roomName" [(ngModel)]="room" placeholder="Enter room name" maxlength="20"
                 class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
        </div>
        <div class="mb-6 text-left">
          <label for="nickname" class="block text-gray-300 text-sm font-semibold mb-2">Nickname:</label>
          <input id="nickname" [(ngModel)]="nickname" placeholder="Enter your nickname" maxlength="20"
                 class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
        </div>
        <button (click)="joinRoom()"
                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl">
          Join Room
        </button>
        <button (click)="spotifyAuth.logout()" 
                class="mt-3 text-gray-400 hover:text-gray-300 text-sm">
          Logout
        </button>
      </div>
    }
  }

  @if(isJoined() && !gameStarted() && !gameEnded()) {
    <div class="w-full max-w-lg bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl text-center border border-gray-700">
      <h2 class="text-2xl sm:text-3xl font-bold text-white mb-4">üè† Room: {{room()}}</h2>

      <h3 class="text-xl sm:text-2xl font-semibold text-gray-300 mb-4">üë• Players:</h3>
      <ul class="player-list space-y-2 mb-6">
        @for(player of players(); track player.nickname) {
          <li class="flex flex-col sm:flex-row items-center justify-between p-3 bg-gray-700 rounded-lg shadow-sm border border-gray-600">
            <span class="font-medium text-white">{{player.nickname}}</span>
            <span class="text-gray-300 text-sm">Song: {{player.hasUploaded ? '‚úÖ' : '‚ùå'}}</span>
            <span class="text-gray-300 text-sm">Score: {{player.score}}</span>
          </li>
        }
      </ul>

      <!-- Submitted Songs Section -->
      @if (players().length > 0) {
        <div class="bg-gray-700 p-4 rounded-lg mb-6 border border-gray-600">
          <h4 class="text-lg font-semibold text-yellow-400 mb-3">üéµ Submitted Songs:</h4>
          <div class="space-y-2">
            @for (player of players(); track player.nickname) {
              <div class="flex items-center justify-between p-3 bg-gray-600 rounded border border-gray-500">
                <div class="flex items-center gap-3">
                  <span class="font-medium text-white">{{player.nickname}}</span>
                  @if (player.hasUploaded) {
                    <span class="text-green-400 text-sm">‚úÖ Submitted</span>
                  } @else {
                    <span class="text-red-400 text-sm">‚ùå Not submitted</span>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Song Selection Section (Available to ALL players) -->
      <div class="song-selection bg-gray-700 p-6 rounded-lg shadow-lg mb-6 border border-gray-600">
        <h4 class="text-lg sm:text-xl font-semibold text-green-400 mb-4">üéµ Select Your Song:</h4>
        
        <div class="mb-4">
          <input 
            [(ngModel)]="spotifySearchQuery"
            (input)="searchSpotifySongs()"
            placeholder="Search for songs on Spotify..."
            class="w-full px-4 py-3 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
          />
        </div>
        
        <!-- Search Results Dropdown -->
        @if (spotifySearchResults().length > 0) {
          <div class="search-results bg-gray-600 border border-gray-500 rounded-lg max-h-60 overflow-y-auto mb-2">
            @for (track of spotifySearchResults(); track track.id) {
              <div 
                (click)="selectSpotifyTrack(track)"
                class="p-3 hover:bg-gray-500 cursor-pointer border-b border-gray-500 last:border-b-0"
              >
                <div class="flex items-center gap-3">
                  @if (track.album.images[0]) {
                    <img [src]="track.album.images[0].url" [alt]="track.album.name" 
                         class="w-12 h-12 rounded object-cover"/>
                  }
                  <div class="flex-1">
                    <p class="font-semibold text-white">{{track.name}}</p>
                    <p class="text-sm text-gray-300">{{getArtistsNames(track.artists)}}</p>
                    <p class="text-xs text-gray-400">{{track.album.name}}</p>
                  </div>
                  <div class="text-xs text-gray-400">
                    {{formatDuration(track.duration_ms)}}
                  </div>
                </div>
              </div>
            }
          </div>
        }
        
        <!-- Selected Song Display -->
        @if (selectedSpotifyTrack()) {
          <div class="selected-track bg-green-900 p-3 rounded-lg mb-2 border border-green-600">
            <h5 class="font-semibold text-green-300 mb-2">üéµ Your Selected Song:</h5>
            <div class="flex items-center gap-3">
              @if (selectedSpotifyTrack()!.album.images[0]) {
                <img [src]="selectedSpotifyTrack()!.album.images[0].url" 
                     class="w-12 h-12 rounded object-cover"/>
              }
              <div class="flex-1">
                <p class="font-semibold text-sm text-white">{{selectedSpotifyTrack()!.name}}</p>
                <p class="text-xs text-gray-300">{{getArtistsNames(selectedSpotifyTrack()!.artists)}}</p>
                <p class="text-xs text-gray-400">{{selectedSpotifyTrack()!.album.name}}</p>
                @if (selectedSpotifyTrack()!.preview_url) {
                  <p class="text-xs text-green-400">üéµ Preview Available</p>
                } @else {
                  <p class="text-xs text-red-400">üîá No Preview</p>
                }
              </div>
              <div class="text-xs text-gray-400">
                {{formatDuration(selectedSpotifyTrack()!.duration_ms)}}
              </div>
            </div>
          </div>
        }
        
        <!-- Submit Button -->
        @if (selectedSpotifyTrack()) {
          <button (click)="submitSpotifyTrack()" 
                  class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl">
            Submit Song
          </button>
        }
      </div>

      <!-- Host-Only Controls: Turn Duration & Start Game -->
      @if(isHost()) {
        <div class="host-controls bg-gray-700 p-6 rounded-lg shadow-lg mb-6 border border-gray-600">
          <h4 class="text-lg sm:text-xl font-semibold text-blue-400 mb-4">üéÆ Host Controls:</h4>
          
          <div class="mb-6 text-left">
            <label for="turnDuration" class="block text-gray-300 text-sm font-semibold mb-2">Turn Duration (seconds):</label>
            <input id="turnDuration" type="number" [(ngModel)]="turnDuration" min="10" max="120"
                   class="w-full px-4 py-3 bg-gray-600 border border-gray-500 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
            <p class="text-xs text-gray-400 mt-2">Set how long each turn lasts (10-120 seconds)</p>
          </div>
          
          <!-- Start Game Button -->
          @if (allPlayersUploaded()) {
            <button (click)="startGame()" 
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl">
              Start Game
            </button>
          } @else {
            <button disabled 
                    class="w-full bg-gray-600 text-gray-400 font-bold py-3 px-4 rounded-lg cursor-not-allowed">
              Waiting for all players to submit songs...
            </button>
          }
        </div>
      }
    </div>
  }

  @if(isJoined() && gameStarted() && !gameEnded()) {
    <div class="w-full max-w-4xl bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-700">
      <h2 class="text-2xl sm:text-3xl font-bold text-white mb-6 text-center">üéµ Music Guesser Game</h2>

      <!-- Answer Display Overlay -->
      @if (showingAnswer() && answerData()) {
        <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
          <div class="bg-gray-800 rounded-lg p-8 max-w-md mx-4 text-center border border-gray-600">
            <h3 class="text-2xl font-bold text-white mb-4">üéµ The Answer Was:</h3>
            <div class="mb-4">
              <p class="text-xl font-semibold text-blue-400">{{answerData()!.songTitle}}</p>
              <p class="text-lg text-gray-300">by {{answerData()!.songArtist}}</p>
            </div>
            @if (answerData()!.spotifyTrack && answerData()!.spotifyTrack.album.images[0]) {
              <img [src]="answerData()!.spotifyTrack.album.images[0].url" 
                   [alt]="answerData()!.spotifyTrack.album.name"
                   class="w-32 h-32 mx-auto rounded-lg mb-4 object-cover"/>
            }
            <div class="text-sm text-gray-400">
              <p>Next turn starting in 5 seconds...</p>
            </div>
          </div>
        </div>
      }

      <!-- Game Controls -->
      <div class="game-controls flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
        @if (!audioEnabled) {
          <button (click)="enableAudio()" 
                  class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">
            üîä Enable Music
          </button>
        }
        <div class="volume-control flex items-center gap-2 bg-gray-700 p-3 rounded-lg shadow-sm border border-gray-600">
          <label class="text-gray-300 font-medium">Volume: {{volumeControl()}}%</label>
          <input type="range" min="0" max="100" [ngModel]="volumeControl()" (ngModelChange)="volumeControl.set($event)"
                 class="w-full sm:w-32 accent-blue-500"/>
        </div>
      </div>

      <!-- Current Turn Info -->
      <div class="bg-gray-700 p-4 rounded-lg mb-6 border border-gray-600">
        <h3 class="text-xl font-bold text-white mb-2">üéÆ Current Turn:</h3>
        <p class="text-gray-300">It's <span class="font-semibold text-blue-400">{{currentTurnNickname()}}</span>'s turn!</p>
        <p class="text-sm text-gray-400 mt-1">Time remaining: {{timeLeftDisplay}}s</p>
      </div>

      <!-- Current Song Display -->
      <div class="bg-gray-700 p-6 rounded-lg mb-6 border border-gray-600 text-center">
        <h3 class="text-xl font-bold text-white mb-4">üéµ Current Song:</h3>
        <div class="space-y-3">
          <div>
            <p class="text-sm text-gray-400 mb-1">Title:</p>
            <p class="text-2xl font-bold text-blue-400 font-mono tracking-wider">{{revealedTitle()}}</p>
          </div>
          <div>
            <p class="text-sm text-gray-400 mb-1">Artist:</p>
            <p class="text-xl font-semibold text-green-400 font-mono tracking-wider">{{revealedArtist()}}</p>
          </div>
        </div>
      </div>

      <!-- Players List -->
      <div class="bg-gray-700 p-4 rounded-lg mb-6 border border-gray-600">
        <h3 class="text-lg font-semibold text-white mb-3">üë• Players:</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          @for(player of players(); track player.nickname) {
            <div class="flex items-center justify-between p-3 bg-gray-600 rounded border border-gray-500">
              <span class="font-medium text-white">{{player.nickname}}</span>
              <span class="text-gray-300 text-sm">Score: {{player.score}}</span>
            </div>
          }
        </div>
      </div>

      <!-- Chat Section -->
      <div class="bg-gray-700 p-4 rounded-lg mb-6 border border-gray-600">
        <h3 class="text-lg font-semibold text-white mb-3">üí¨ Game Chat:</h3>
        <div id="chat-display" class="chat-messages bg-gray-600 h-40 overflow-y-auto p-3 rounded border border-gray-500 mb-3">
          @for(message of chatMessages(); track message.timestamp) {
            <div class="mb-2 text-sm">
              @if (message.isGuessResult) {
                <!-- Success message for correct guess -->
                <div class="bg-green-900 bg-opacity-50 p-2 rounded border border-green-600">
                  <span class="font-semibold text-green-400">
                    üéâ {{message.guesserNickname}} guessed correctly!
                  </span>
                  <div class="mt-1 text-xs text-green-300">
                    @if (message.titleCorrect && message.artistCorrect) {
                      (Title & Artist)
                    } @else if (message.titleCorrect) {
                      (Title)
                    } @else if (message.artistCorrect) {
                      (Artist)
                    }
                  </div>
                </div>
              } @else {
                <!-- Regular chat message -->
                <span class="font-semibold text-blue-400">{{message.nickname}}:</span>
                <span class="text-gray-300 ml-2">{{message.message}}</span>
              }
            </div>
          }
        </div>
        <div class="flex gap-2">
          <input 
            [(ngModel)]="chatInput" 
            (keydown.enter)="sendChatMessage()"
            placeholder="Type your guess or message..."
            class="flex-1 px-3 py-2 bg-gray-600 border border-gray-500 rounded text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <button (click)="sendChatMessage()" 
                  class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition duration-300">
            Send
          </button>
        </div>
      </div>

      <!-- Host Controls -->
      @if(isHost()) {
        <div class="bg-gray-700 p-4 rounded-lg border border-gray-600">
          <h3 class="text-lg font-semibold text-white mb-3">üéÆ Host Controls:</h3>
          <div class="flex gap-3">
            <button (click)="skipTurn()" 
                    class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded transition duration-300">
              Skip Turn
            </button>
            <button (click)="resetGame()" 
                    class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded transition duration-300">
              Reset Game
            </button>
          </div>
        </div>
      }
    </div>
  }

  @if(isJoined() && gameEnded()) {
    <div class="w-full max-w-lg bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl text-center border border-gray-700">
      <h2 class="text-2xl sm:text-3xl font-bold text-white mb-6">üéâ Game Over!</h2>
      
      <h3 class="text-xl font-semibold text-yellow-400 mb-4">üèÜ Final Scores:</h3>
      <ul class="space-y-2 mb-6">
        @for(score of scores(); track score.nickname) {
          <li class="flex justify-between items-center p-3 bg-gray-700 rounded-lg border border-gray-600">
            <span class="font-medium text-white">{{score.nickname}}</span>
            <span class="text-gray-300">{{score.score}} points</span>
          </li>
        }
      </ul>
      
      @if(isHost()) {
        <button (click)="resetGame()" 
                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl">
          Play Again
        </button>
      } @else {
        <p class="text-gray-400">Waiting for host to start a new game...</p>
      }
    </div>
  }

</div>